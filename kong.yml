# kong.yml

_format_version: "3.0"
_comment: "Declarative configuration for Go-Shop API Gateway"

# =======================================================
# 1. Định nghĩa các Upstream Services (các microservices của bạn)
# Kong sẽ sử dụng tên service trong Docker network để giao tiếp.
# =======================================================
services:
  - name: user-service
    url: http://user-service:8080
  - name: shop-service
    url: http://shop-service:8081
  - name: product-service
    url: http://product-service:8082
  - name: cart-service
    url: http://cart-service:8083
  - name: order-service
    url: http://order-service:8084
  - name: payment-service
    url: http://payment-service:8085

# =======================================================
# 2. Định nghĩa các Routes (ánh xạ URL tới service)
# =======================================================
routes:
  # --- Public Routes (Không cần xác thực) ---
  - name: auth-routes
    service: user-service
    paths:
      - /api/v1/auth/
    methods: 
      - POST
      - GET
    strip_path: false
    plugins:
      - name: jwt # Ghi đè plugin global, tắt xác thực cho route này
        enabled: false

  - name: ipn-routes
    service: payment-service
    paths:
      - /api/v1/payments/ipn/
    strip_path: false
    plugins:
      - name: jwt # Tắt xác thực cho route IPN
        enabled: false

  # --- Protected Routes (Cần xác thực) ---
  - name: user-routes
    service: user-service
    paths:
      - /api/v1/users
    strip_path: false

  - name: shop-routes
    service: shop-service
    paths:
      - /api/v1/shops
    strip_path: false

  - name: product-routes
    service: product-service
    paths:
      - /api/v1/products
    strip_path: false

  - name: cart-routes
    service: cart-service
    paths:
      - /api/v1/carts
    strip_path: false

  - name: order-routes
    service: order-service
    paths:
      - /api/v1/orders
    strip_path: false
  
  - name: payment-protected-routes
    service: payment-service
    paths:
      - /api/v1/payments
    strip_path: false

# =======================================================
# 3. Kích hoạt Plugin JWT trên toàn cục
# Mọi request đi qua Kong sẽ được kiểm tra bởi plugin này,
# trừ khi bị ghi đè (disabled) ở một route cụ thể.
# =======================================================
plugins:
  - name: jwt
    config:
      secret_is_base64: false
      # Kong sẽ tìm claim 'iss' trong token để xác định consumer.
      key_claim_name: iss 
      # Yêu cầu Kong xác thực claim 'exp' (expiration time).
      claims_to_verify:
        - exp
      # Tự động lấy các claim từ payload của JWT và thêm vào header 
      # gửi lên các service backend. Đây là phần thay thế cho NJS script.
      # Tên claim (ví dụ: UserId) phải khớp với tên trong struct CustomJwtClaims.
      claim_to_header:
        - UserId: X-User-ID
        - Role: X-User-Role
        - Email: X-User-Email
      run_on_preflight: true

# =======================================================
# 4. Tạo Consumer và JWT Credential
# Consumer đại diện cho một client sử dụng API của bạn.
# JWT credential liên kết secret key với consumer đó.
# =======================================================
consumers:
  - username: go-shop-consumer
    jwt_secrets:
      - key: ${JWT_ISSUER} # Phải khớp với 'iss' trong token
        # Kong sẽ tự động lấy giá trị từ biến môi trường
        secret: ${JWT_SECRET_KEY} 